<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>仓库货架布局演示</title>
  <!-- 引入Vue2 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>
  <!-- 引入Element UI -->
  <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/index.min.js"></script>
  <!-- 引入Element UI中文语言包 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/locale/zh-CN.min.js"></script>
  <!-- 引入Element UI CSS -->
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/theme-chalk/index.css">
  <style>
    .shelf .popover-hover-area {
      position: absolute;
      width: 100%;
      height: 100%;
      /* background-color: rgba(0, 0, 0, 0.5); */
      z-index: 1000;
      top: 0;
      left: 0;
    }

    .product-modal-content {
      height: 500px;
      display: flex;
      flex-direction: column;
    }

    .product-modal-content .product-modal-content-body {
      flex: 1;
      overflow-y: auto;
    }

    .product-modal-content .product-modal-content-body-item {
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }



    .inventory-details-modal-content {
      height: 500px;
      display: flex;
      flex-direction: column;

    }

    .inventory-details-modal-content .inventory-details-modal-content-body {
      flex: 1;
      overflow-y: auto;
    }

    .inventory-details-modal-content .inventory-details-modal-content-body-item {
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .warehouse-container {
      position: relative;
      background-color: #fff;
      border: 2px solid #333;
      margin: 0 auto;
      background-image: linear-gradient(#eee 1px, transparent 1px),
        linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 20px 20px;
      min-width: 400px;
      min-height: 300px;
      max-width: 1200px;
      max-height: 800px;
      transition: all 0.05s ease-out;
      will-change: width, height;
      transform: translate3d(0, 0, 0);
    }

    .warehouse-container.design-mode {
      resize: both;
      /* 允许在设计模式下调整大小 */
    }

    .resize-edge {
      position: absolute;
      background-color: transparent;
      z-index: 10;
      transition: background-color 0.2s;
    }

    .resize-edge:hover {
      background-color: rgba(64, 158, 255, 0.1);
    }

    .resize-edge.right {
      top: 0;
      right: 0;
      width: 12px;
      height: 100%;
      cursor: e-resize;
    }

    .resize-edge.bottom {
      bottom: 0;
      left: 0;
      width: 100%;
      height: 12px;
      cursor: s-resize;
    }

    .resize-edge.corner {
      right: 0;
      bottom: 0;
      width: 20px;
      height: 20px;
      cursor: se-resize;
      border-radius: 0 0 4px 0;
    }

    .resize-indicator {
      position: absolute;
      right: 5px;
      bottom: 5px;
      width: 20px;
      height: 20px;
      color: #666;
      font-size: 18px;
      pointer-events: none;
      /* 确保不干扰resize操作 */
      display: none;
    }

    .warehouse-container.design-mode:hover .resize-indicator {
      display: block;
    }

    .shelf {
      position: absolute;
      background-color: #ffd699;
      border: 2px solid #ff9900;
      border-radius: 4px;
      cursor: move;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 1;
      user-select: none;
      min-width: 60px;
      min-height: 60px;
      margin-bottom: 40px;
      transition: box-shadow 0.3s;
    }

    .shelf:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .shelf.view-mode {
      cursor: pointer;
    }

    .shelf.selected {
      border-color: #409EFF;
      box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.3);
    }

    .shelf-header {
      background-color: #ff9900;
      color: white;
      padding: 4px;
      font-size: 12px;
      text-align: center;
      cursor: move;
    }

    .shelf-body {
      position: relative;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }

    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #666;
      border-radius: 50%;
      z-index: 2;
    }

    .resize-handle.nw {
      top: -5px;
      left: -5px;
      cursor: nw-resize;
    }

    .resize-handle.ne {
      top: -5px;
      right: -5px;
      cursor: ne-resize;
    }

    .resize-handle.sw {
      bottom: -5px;
      left: -5px;
      cursor: sw-resize;
    }

    .resize-handle.se {
      bottom: -5px;
      right: -5px;
      cursor: se-resize;
    }

    .ghost {
      opacity: 0.5;
      background-color: #c8ebfb !important;
      border: 2px dashed #4a9ed1 !important;
    }

    .controls {
      margin: 20px auto;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
    }

    .mode-switch {
      max-width: 800px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    /* 移除不再需要的按钮样式 */
    .mode-button {
      display: none;
    }

    /* 优化操作区样式 */
    .operation-panel {
      max-width: 800px;
      margin: 15px auto;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .operation-panel-header {
      background-color: #f5f7fa;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e6e6e6;
    }

    .operation-panel-title {
      font-size: 16px;
      font-weight: bold;
      color: #303133;
    }

    .operation-panel-content {
      padding: 15px;
    }

    /* 美化按钮样式 */
    .el-button--primary {
      background-color: #409EFF;
      border-color: #409EFF;
    }

    .el-button--success {
      background-color: #67C23A;
      border-color: #67C23A;
    }

    .el-button--danger {
      background-color: #F56C6C;
      border-color: #F56C6C;
    }

    .el-button--warning {
      background-color: #E6A23C;
      border-color: #E6A23C;
    }

    .operation-button {
      margin-right: 8px;
    }

    .operation-button i {
      margin-right: 4px;
    }

    /* 移除不再需要的货架操作按钮样式 */
    .shelf-action-btn {
      display: none;
    }

    .operation-panel-footer {
      background-color: #f5f7fa;
      padding: 10px 15px;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid #e6e6e6;
    }

    .operation-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .operation-row:last-child {
      margin-bottom: 0;
    }

    .operation-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .operation-label {
      font-weight: bold;
      margin-right: 10px;
      min-width: 80px;
    }

    /* 优化货架操作按钮容器 */
    .shelf-options {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      justify-content: center;
      z-index: 10;
      margin-top: 5px;
      white-space: nowrap;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    /* 移除不再需要的按钮样式 */
    .shelf-option-btn,
    .view-inventory-btn,
    .edit-sku-btn {
      display: none;
    }

    /* 优化货架按钮间距 */
    .shelf-options .el-button {
      margin: 0 4px;
    }

    .shelf-action-btn.add {
      background-color: #67C23A;
    }

    .shelf-action-btn.add:hover {
      background-color: #85ce61;
    }

    .shelf-action-btn.clear {
      background-color: #F56C6C;
    }

    .shelf-action-btn.clear:hover {
      background-color: #f78989;
    }

    .mode-icon {
      margin-right: 5px;
      font-size: 16px;
    }

    .mode-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 8px;
    }

    .mode-status.design {
      background-color: #4CAF50;
    }

    .mode-status.view {
      background-color: #2196F3;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.toggle-slider {
      background-color: #4CAF50;
    }

    input:checked+.toggle-slider:before {
      transform: translateX(30px);
    }

    .save-button {
      margin-left: 10px;
      padding: 8px 15px;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .save-button:hover {
      background-color: #45a049;
    }

    .save-button:disabled {
      background-color: #cccccc;
      color: #888888;
      cursor: not-allowed;
    }

    .info-panel {
      max-width: 800px;
      margin: 20px auto;
      background-color: white;
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }

    .shelf-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }

    .info-panel-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #303133;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-panel-actions {
      display: flex;
      gap: 10px;
    }

    .shelf-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px auto;
      max-width: 800px;
      background-color: #f0f0f0;
      padding: 10px 20px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .shelf-controls .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .shelf-controls .selected-shelf-info {
      margin-right: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    .shelf-edit-btn {
      background-color: #409EFF;
    }

    .shelf-edit-btn:hover {
      background-color: #66B1FF;
    }

    .shelf-delete-btn {
      background-color: #F56C6C;
    }

    .shelf-delete-btn:hover {
      background-color: #F78989;
    }

    .size-label {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin-right: 5px;
      border-radius: 50%;
    }

    .size-label.small {
      background-color: #2196F3;
    }

    .size-label.medium {
      background-color: #ff9800;
    }

    .size-label.large {
      background-color: #f44336;
    }

    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      color: #888888;
      cursor: not-allowed;
    }

    .warehouse-size-info {
      position: absolute;
      right: 10px;
      top: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #333;
      pointer-events: none;
      z-index: 5;
    }

    .warehouse-size-presets {
      display: flex;
      justify-content: center;
      margin: 10px auto;
      gap: 10px;
      max-width: 800px;
      padding: 10px;
      background-color: #f5f7fa;
      border-radius: 4px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
    }

    .size-preset {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .size-preset:hover {
      background-color: #e0e0e0;
    }

    .size-preset.active {
      background-color: #2196F3;
      color: white;
      border-color: #0b7dda;
    }

    .search-container {
      display: flex;
      align-items: center;
      margin: 15px auto;
      max-width: 800px;
      background-color: transparent;
      padding: 0;
      border-radius: 4px;
      box-shadow: none;
    }

    /* 移除不再需要的搜索按钮样式 */
    .search-button,
    .search-input,
    .search-clear {
      display: none;
    }

    /* 调整搜索结果显示 */
    .search-result-status {
      margin-left: 10px;
      font-size: 14px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .shelf.hidden {
      display: none;
    }

    /* 货架操作选项样式 */
    .shelf-options {
      position: absolute;
      top: 100%;
      /* 改为100%，使其位于货架下方 */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      justify-content: center;
      z-index: 10;
      margin-top: 5px;
      /* 添加上边距 */
      white-space: nowrap;
      /* 防止按钮换行 */
      background-color: rgba(255, 255, 255, 0.9);
      /* 添加半透明背景 */
      padding: 5px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .shelf-option-btn {
      margin: 0 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-inventory-btn {
      background-color: #2196F3;
      color: white;
    }

    .view-inventory-btn:hover {
      background-color: #1976D2;
    }

    .edit-sku-btn {
      background-color: #FF9800;
      color: white;
    }

    .edit-sku-btn:hover {
      background-color: #F57C00;
    }

    /* 弹出层样式 */
    .el-dialog__body {
      padding: 10px 20px !important;
    }

    .el-table {
      margin-bottom: 10px;
    }

    .el-table .selected-row {
      background-color: #e3f2fd;
    }

    .el-dialog__header {
      padding: 15px 20px !important;
      border-bottom: 1px solid #eee;
    }

    .el-dialog__footer {
      padding: 10px 20px 15px !important;
      border-top: 1px solid #eee;
    }

    /* 货架操作按钮样式 */
    .shelf-design-options {
      display: none;
    }

    /* 弹框内容样式优化 */
    .inventory-details-modal-content,
    .product-modal-content {
      height: 500px;
      display: flex;
      flex-direction: column;
    }

    .inventory-details-modal-content-header,
    .product-modal-content-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      font-weight: bold;
      color: #303133;
    }

    .inventory-details-modal-content-body,
    .product-modal-content-body {
      flex: 1;
      overflow-y: auto;
    }

    .inventory-details-modal-content-body-item,
    .product-modal-content-body-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
    }

    .inventory-details-modal-content-body-item:hover,
    .product-modal-content-body-item:hover {
      background-color: #f5f7fa;
    }

    /* 网格线样式 */
    .grid-lines {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.05);
    }

    .grid-line-horizontal {
      left: 0;
      width: 100%;
      height: 1px;
    }

    .grid-line-vertical {
      top: 0;
      width: 1px;
      height: 100%;
    }

    /* 对齐辅助线样式 */
    .alignment-guide {
      position: absolute;
      background-color: #409EFF;
      z-index: 1000;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .alignment-guide-vertical {
      width: 1px;
      height: 100%;
      top: 0;
    }

    .alignment-guide-horizontal {
      height: 1px;
      width: 100%;
      left: 0;
    }

    /* 网格切换开关 */
    .grid-switch {
      display: flex;
      align-items: center;
      margin-left: 15px;
    }

    /* 框选区域样式 */
    .selection-box {
      position: absolute;
      border: 1.5px dashed #409EFF;
      background-color: rgba(64, 158, 255, 0.1);
      z-index: 999;
      pointer-events: none;
    }
    
    /* 对齐工具栏样式 */
    .alignment-toolbar {
      position: absolute;
      background-color: white;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      padding: 8px;
      z-index: 1200;
      display: flex;
      gap: 5px;
      border: 1px solid #EBEEF5;
    }
    
    .alignment-toolbar .el-button {
      padding: 6px 8px;
    }
    
    /* 多选时货架的样式 */
    .shelf.multi-selected {
      border-color: #409EFF;
      box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.3);
    }
  </style>
</head>

<body>
  <div id="app">
    <h1 style="text-align: center;">仓库货架布局管理</h1>

    <!-- 重构操作区，使用新的样式 -->
    <div class="operation-panel">
      <div class="operation-panel-header">
        <div class="operation-panel-title">操作面板</div>
        <div class="mode-switch">
          <el-button :type="designMode ? 'success' : 'primary'" size="small" @click="toggleMode"
            :icon="designMode ? 'el-icon-check' : 'el-icon-edit'">
            {{ designMode ? '保存布局' : '设计布局' }}
          </el-button>
          <div class="grid-switch" v-if="designMode">
            <el-switch v-model="gridEnabled" active-text="网格对齐" inactive-text="自由拖动">
            </el-switch>
          </div>
        </div>
      </div>
      <div class="operation-panel-content">
        <!-- 设计模式下的操作 -->
        <div v-if="designMode">
          <div class="operation-row">
            <div class="operation-group">
              <div class="operation-label">货架操作:</div>
              <el-button type="success" size="small" icon="el-icon-plus" @click="addShelf">
                添加新货架
              </el-button>
              <el-button type="danger" size="small" icon="el-icon-delete" @click="clearLayout">
                清空布局
              </el-button>
            </div>
            <div class="operation-group" v-if="currentShelf !== null">
              <div class="operation-label">尺寸设置:</div>
              <el-button size="small" @click="setShelfSize('small')" type="primary" plain>
                <span class="size-label small"></span> 小尺寸
              </el-button>
              <el-button size="small" @click="setShelfSize('medium')" type="warning" plain>
                <span class="size-label medium"></span> 中尺寸
              </el-button>
              <el-button size="small" @click="setShelfSize('large')" type="danger" plain>
                <span class="size-label large"></span> 大尺寸
              </el-button>
            </div>
          </div>
          <div class="operation-row" v-if="currentShelf !== null">
            <div class="operation-group">
              <div class="operation-label">当前选中:</div>
              <div class="selected-shelf-info">
                <el-tag type="success">货架 #{{ shelves[currentShelf].id }}</el-tag>
                <span style="margin-left: 5px;">{{ shelves[currentShelf].name }}</span>
              </div>
            </div>
            <div class="operation-group">
              <el-button size="small" type="primary" icon="el-icon-edit" @click="editShelfName(currentShelf)">
                编辑名称
              </el-button>
              <el-button size="small" type="danger" icon="el-icon-delete" @click="deleteShelf(currentShelf)">
                删除货架
              </el-button>
            </div>
          </div>
        </div>
        <!-- 查看模式下的操作 -->
        <div v-else>
          <div class="operation-row">
            <div class="search-container" style="margin: 0; flex: 1; box-shadow: none; background: transparent;">
              <el-input v-model="searchQuery" placeholder="输入货架ID、名称或区域进行搜索" prefix-icon="el-icon-search" clearable
                @keyup.enter.native="searchShelves" style="width: 100%;">
                <el-button slot="append" icon="el-icon-search" @click="searchShelves">搜索</el-button>
              </el-input>
            </div>
            <div class="search-result-status" v-if="isSearchActive">
              <el-tag type="info">找到 {{ filteredShelves.length }} 个匹配货架</el-tag>
              <el-button type="text" icon="el-icon-close" @click="clearSearch">清除搜索</el-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="warehouse-container" :class="{'design-mode': designMode}" ref="warehouseRef"
      @mousedown.left="designMode && startSelection($event)">
      <div class="resize-indicator" v-if="designMode">⤡</div>
      <div class="warehouse-size-info" v-if="designMode">
        {{ warehouseWidth }} × {{ warehouseHeight }} 像素
      </div>

      <!-- 框选区域 -->
      <div v-if="selectionBox.isSelecting" class="selection-box" :style="{
                         left: selectionBox.x + 'px',
                         top: selectionBox.y + 'px',
                         width: selectionBox.width + 'px',
                         height: selectionBox.height + 'px'
                       }">
      </div>
      
      <!-- 对齐工具栏 -->
      <div v-if="designMode && selectedShelves.length > 1" class="alignment-toolbar" :style="{
                         left: alignmentToolbarPosition.x + 'px',
                         top: alignmentToolbarPosition.y + 'px'
                       }">
        <el-button size="mini" type="primary" plain icon="el-icon-s-fold" title="左对齐"
          @click="alignSelectedShelves('left')"></el-button>
        <el-button size="mini" type="primary" plain icon="el-icon-s-unfold" title="右对齐"
          @click="alignSelectedShelves('right')"></el-button>
        <el-button size="mini" type="primary" plain icon="el-icon-sort-up" title="上对齐"
          @click="alignSelectedShelves('top')"></el-button>
        <el-button size="mini" type="primary" plain icon="el-icon-sort-down" title="下对齐"
          @click="alignSelectedShelves('bottom')"></el-button>
        <el-button size="mini" type="primary" plain icon="el-icon-menu" title="垂直居中对齐"
          @click="alignSelectedShelves('centerV')"></el-button>
        <el-button size="mini" type="primary" plain icon="el-icon-more" title="水平居中对齐"
          @click="alignSelectedShelves('centerH')"></el-button>
        <el-button size="mini" type="danger" plain icon="el-icon-close" title="取消选择"
          @click="clearSelectedShelves"></el-button>
      </div>

      <!-- 网格线 -->
      <div class="grid-lines" v-if="designMode && showGrid">
        <div class="grid-line grid-line-horizontal" v-for="i in Math.floor(warehouseHeight / gridSize)" :key="'h-' + i"
          :style="{top: (i * gridSize) + 'px'}">
        </div>
        <div class="grid-line grid-line-vertical" v-for="i in Math.floor(warehouseWidth / gridSize)" :key="'v-' + i"
          :style="{left: (i * gridSize) + 'px'}">
        </div>
      </div>
      
      <!-- 对齐辅助线 -->
      <div v-if="designMode && isDragging && alignmentGuides.show">
        <div v-for="(guide, index) in alignmentGuides.vertical" :key="'v-guide-' + index"
          class="alignment-guide alignment-guide-vertical" :style="{left: guide + 'px'}">
        </div>
        <div v-for="(guide, index) in alignmentGuides.horizontal" :key="'h-guide-' + index"
          class="alignment-guide alignment-guide-horizontal" :style="{top: guide + 'px'}">
        </div>
      </div>

      <!-- 添加调整大小的边缘处理，只在设计模式下显示 -->
      <div v-if="designMode" class="resize-edge right" @mousedown.stop="startResizeWarehouse('right', $event)"></div>
      <div v-if="designMode" class="resize-edge bottom" @mousedown.stop="startResizeWarehouse('bottom', $event)"></div>
      <div v-if="designMode" class="resize-edge corner" @mousedown.stop="startResizeWarehouse('corner', $event)"></div>

      <template v-for="(shelf, index) in shelves" :key="shelf.id">
        <div class="shelf"
          :class="{ 
            'view-mode': !designMode,  
            'hidden': !designMode && isSearchActive && !isShelfVisible(shelf),  
            'selected': currentShelf === index && designMode,
            'multi-selected': isShelfSelected(index)
          }"
          :style="{  width: shelf.width + 'px', height: shelf.height + 'px', left: shelf.x + 'px', top: shelf.y + 'px' }"
          @click.stop="designMode ? selectShelf(index) : showShelfOptions(shelf.id)">
          <div class="shelf-body" @mousedown.stop="designMode && startDrag(index, $event)">{{ shelf.name }}</div>
          <!-- 调整大小的四个手柄，只在设计模式显示 -->
          <div v-if="designMode" class="resize-handle nw" @mousedown.stop="startResize(index, 'nw', $event)"></div>
          <div v-if="designMode" class="resize-handle ne" @mousedown.stop="startResize(index, 'ne', $event)"></div>
          <div v-if="designMode" class="resize-handle sw" @mousedown.stop="startResize(index, 'sw', $event)"></div>
          <div v-if="designMode" class="resize-handle se" @mousedown.stop="startResize(index, 'se', $event)"></div>

          <!-- 查看模式下点击货架显示的操作选项 -->
          <div class="shelf-options" v-if="!designMode && selectedShelfId === shelf.id" @click.stop>
            <el-button size="mini" type="primary" icon="el-icon-document" @click.stop="viewShelfInventory(shelf)">
              查看库存
            </el-button>
            <el-button size="mini" type="warning" icon="el-icon-edit" @click.stop="editShelfSku(shelf)">
              修改款号
            </el-button>
          </div>
          <el-popover placement="top-start" title="款号信息" width="400" trigger="hover">
            <div class="popover-hover-area" slot="reference" v-show="!designMode && !selectedShelfId"></div>
            <el-table :data="gridData">
              <el-table-column width="150" property="date" label="日期"></el-table-column>
              <el-table-column width="100" property="name" label="姓名"></el-table-column>
              <el-table-column width="300" property="address" label="地址"></el-table-column>
            </el-table>
          </el-popover>
        </div>
      </template>

    </div>

    <div v-if="designMode">
      <div class="warehouse-size-presets">
        <div class="info-panel-title" style="margin-bottom: 10px;">
          <span>仓库尺寸预设</span>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
          <el-button size="small" v-for="preset in sizePresets" :key="preset.name"
            :type="warehouseWidth === preset.width && warehouseHeight === preset.height ? 'primary' : 'info'"
            @click="applyWarehouseSize(preset.width, preset.height)" plain>
            {{ preset.name }} ({{ preset.width }}×{{ preset.height }})
          </el-button>
        </div>
      </div>
    </div>

    <div class="info-panel" v-if="shelves.length > 0">
      <div class="info-panel-title">
        <span>货架布局信息</span>
        <div class="info-panel-actions">
          <el-button size="mini" type="text" icon="el-icon-refresh" @click="refreshShelfInfo">刷新</el-button>
          <el-switch v-model="showDetailedInfo" active-text="详细信息" inactive-text="简略信息">
          </el-switch>
        </div>
      </div>
      <el-table :data="shelves" style="width: 100%" size="mini" border>
        <el-table-column prop="id" label="ID" width="60" sortable></el-table-column>
        <el-table-column prop="name" label="名称" width="150"></el-table-column>
        <el-table-column label="位置" width="200">
          <template slot-scope="scope">
            X: {{ scope.row.x }}, Y: {{ scope.row.y }}
          </template>
        </el-table-column>
        <el-table-column label="尺寸" width="150">
          <template slot-scope="scope">
            {{ scope.row.width }} × {{ scope.row.height }}
          </template>
        </el-table-column>
        <el-table-column prop="sku" label="款号" width="100" v-if="showDetailedInfo"></el-table-column>
        <el-table-column label="库存" v-if="showDetailedInfo">
          <template slot-scope="scope">
            {{ scope.row.inventory.length }} 种产品
          </template>
        </el-table-column>
      </el-table>
    </div>

    <el-dialog :visible.sync="showModal.showInventoryDetailsModal" title="货架库存详情" width="500px" :before-close="closeModal"
      :append-to-body="true" :close-on-click-modal="false" :close-on-press-escape="false" center>
      <div class="inventory-details-modal-content">
        <div class="inventory-details-modal-content-header">
          <span>{{ modalTitle.inventoryDetailsModalTitle }}</span>
        </div>
        <div class="inventory-details-modal-content-body" v-infinite-scroll="loadInventoryDetailsModalData">
          <div class="inventory-details-modal-content-body-item" v-for="(item,index) in inventoryDetailsModalData"
            :key="index">
            <span>SKU001</span>
            <span>100</span>
          </div>
        </div>
      </div>
    </el-dialog>
    <el-dialog :visible.sync="showModal.showEditSkuModal" title="修改货架款号" width="500px" :before-close="closeModal"
      :append-to-body="true" :close-on-click-modal="false" :close-on-press-escape="false" center>
      <div class="product-modal-content">
        <div class="product-modal-content-header">
          <span>{{ modalTitle.editSkuModalTitle }}</span>
        </div>
        <div class="product-modal-content-body" v-infinite-scroll="loadInventoryDetailsModalData">
          <div class="product-modal-content-body-item" v-for="(item,index) in inventoryDetailsModalData" :key="index">
            <span>SKU001</span>
            <span>100</span>
          </div>
        </div>
      </div>
    </el-dialog>
  </div>

  <!-- 引入Sortable -->
  <script src="https://cdn.bootcdn.net/ajax/libs/Sortable/1.10.2/Sortable.min.js"></script>
  <!-- 引入Vue.Draggable -->
  <script src="https://cdn.bootcdn.net/ajax/libs/Vue.Draggable/2.24.3/vuedraggable.umd.min.js"></script>

  <script>
    // 使用Element UI
    Vue.use(ELEMENT)
    ELEMENT.locale(ELEMENT.lang.zhCN) // 设置语言为中文

    new Vue({
      el: '#app',
      data: {
        gridData: [{
          date: '2016-05-02',
          name: '王小虎',
          address: '上海市普陀区金沙江路 1518 弄'
        }, {
          date: '2016-05-04',
          name: '王小虎',
          address: '上海市普陀区金沙江路 1518 弄'
        }, {
          date: '2016-05-01',
          name: '王小虎',
          address: '上海市普陀区金沙江路 1518 弄'
        }, {
          date: '2016-05-03',
          name: '王小虎',
          address: '上海市普陀区金沙江路 1518 弄'
        }],
        shelves: [
          { id: 1, name: 'A区-1号', x: 50, y: 50, width: 100, height: 80, sku: 'SKU001', inventory: [{ sku: 'A1001', quantity: 50 }, { sku: 'A1002', quantity: 30 }] },
          { id: 2, name: 'A区-2号', x: 200, y: 50, width: 120, height: 80, sku: 'SKU002', inventory: [{ sku: 'A2001', quantity: 20 }] },
          { id: 3, name: 'B区-1号', x: 50, y: 200, width: 150, height: 100, sku: 'SKU003', inventory: [] },
          { id: 4, name: 'B区-2号', x: 250, y: 200, width: 100, height: 150, sku: 'SKU004', inventory: [{ sku: 'B2001', quantity: 60 }, { sku: 'B2002', quantity: 45 }] }
        ],
        nextId: 5,
        currentShelf: null,
        isDragging: false,
        isResizing: false,
        isResizingWarehouse: false,
        resizeDirection: null,
        warehouseResizeDirection: null,
        startX: 0,
        startY: 0,
        startWidth: 0,
        startHeight: 0,
        startTop: 0,
        startLeft: 0,
        dragOffsetX: 0,
        dragOffsetY: 0,
        shelfSizes: {
          small: { width: 80, height: 60 },
          medium: { width: 120, height: 90 },
          large: { width: 180, height: 120 }
        },
        modalTitle: {
          inventoryDetailsModalTitle: '货架xxx库存详情',
          editSkuModalTitle: '修改货架xxx款号'
        },
        designMode: false, // 默认进入查看模式
        warehouseWidth: 800,
        warehouseHeight: 600,
        sizePresets: [
          { name: '小型仓库', width: 600, height: 400 },
          { name: '中型仓库', width: 800, height: 600 },
          { name: '大型仓库', width: 1000, height: 700 }
        ],
        searchQuery: '',
        isSearchActive: false,
        filteredShelves: [],
        // 货架操作相关
        selectedShelfId: null,
        showModal: {
          showInventoryDetailsModal: false,
          showEditSkuModal: false
        },

        inventoryDetailsModalData: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        currentModalShelf: null,
        selectedSkuIndex: -1,
        // 写死的款号数据
        skuList: [
          { code: 'SKU001', status: '正常' },
          { code: 'SKU002', status: '正常' },
          { code: 'SKU003', status: '缺货' },
          { code: 'SKU004', status: '正常' },
          { code: 'SKU005', status: '停产' },
          { code: 'SKU006', status: '正常' },
          { code: 'SKU007', status: '新品' },
          { code: 'SKU008', status: '热销' }
        ],
        showDetailedInfo: true,
        copyBuffer: null, // 用于存储复制的货架
        pasteOffset: 20, // 粘贴时的偏移量
        gridSize: 20, // 网格大小
        gridEnabled: true, // 是否启用网格对齐
        showGrid: true, // 是否显示网格线
        alignmentThreshold: 10, // 对齐吸附阈值
        alignmentGuides: { // 对齐辅助线
          show: false,
          vertical: [],
          horizontal: []
        },
        // 框选功能相关
        selectionBox: {
          isSelecting: false,
          startX: 0,
          startY: 0,
          x: 0,
          y: 0,
          width: 0,
          height: 0
        },
        selectedShelves: [], // 存储多选的货架索引
        alignmentToolbarPosition: { x: 0, y: 0 } // 对齐工具栏位置
      },
      mounted() {
        console.log(document)

        // 全局监听鼠标事件，用于处理货架调整大小
        // 在document级别监听可确保即使鼠标移出货架元素，也能持续捕获鼠标移动
        document.addEventListener('mousemove', this.onMouseMove)
        document.addEventListener('mouseup', this.onMouseUp)

        // 添加键盘事件监听，用于复制粘贴功能
        document.addEventListener('keydown', this.handleKeyDown)

        // 添加全局鼠标事件监听，用于框选功能
        document.addEventListener('mousemove', this.onSelectionMove)
        document.addEventListener('mouseup', this.endSelection)

        // 在DOM更新后初始化事件和尺寸
        this.$nextTick(() => {
          // 确保在Vue更新DOM后绑定事件
          const warehouseEl = this.$refs.warehouseRef
          if (warehouseEl) {
            // 监听仓库容器的点击事件，用于取消选中货架
            warehouseEl.addEventListener('mousedown', this.onWarehouseClick)
            // 初始化仓库尺寸
            this.updateWarehouseSize()
          }
        })
      },
      beforeDestroy() {
        // 组件销毁前移除所有事件监听器，防止内存泄漏
        // 移除document上的全局事件监听
        document.removeEventListener('mousemove', this.onMouseMove)
        document.removeEventListener('mouseup', this.onMouseUp)
        document.removeEventListener('mousemove', this.onWarehouseResize)
        document.removeEventListener('mouseup', this.onWarehouseResizeEnd)
        document.removeEventListener('keydown', this.handleKeyDown)
        document.removeEventListener('mousemove', this.onSelectionMove)
        document.removeEventListener('mouseup', this.endSelection)

        // 移除仓库容器上的事件监听
        const warehouseEl = this.$refs.warehouseRef
        if (warehouseEl) {
          warehouseEl.removeEventListener('mousedown', this.onWarehouseClick)
        }
      },
      methods: {
        loadInventoryDetailsModalData() {
          console.log('loadInventoryDetailsModalData')
        },
        addShelf() {
          const warehouseEl = this.$refs.warehouseRef
          const width = 100
          const height = 80

          this.shelves.push({
            id: this.nextId,
            name: `新货架-${this.nextId}`,
            x: Math.random() * (warehouseEl.clientWidth - width),
            y: Math.random() * (warehouseEl.clientHeight - height),
            width: width,
            height: height
          })
          this.nextId++

          // 显示添加成功提示
          this.$message({
            message: '新货架添加成功',
            type: 'success',
            duration: 1500
          })
        },
        saveLayout() {
          // 保存布局到LocalStorage
          const warehouseEl = this.$refs.warehouseRef


          const layoutData = {
            shelves: this.shelves,
            warehouseSize: {
              width: warehouseEl.style.width.replace('px', ''),
              height: warehouseEl.style.height.replace('px', '')
            }
          }
          localStorage.setItem('warehouseLayout', JSON.stringify(layoutData))
          this.$message({
            message: '货架布局已保存!',
            type: 'success',
            duration: 1500
          })
        },
        toggleMode() {
          if (this.designMode) {


            // 如果当前是设计模式，点击按钮就是保存布局并切换到查看模式
            this.saveLayout()
            this.designMode = false
          } else {

            // 如果当前是查看模式，点击按钮就是切换到设计模式
            this.designMode = true
          }
        },
        clearLayout() {
          if (!this.designMode) return

          this.$confirm('确定要清空当前布局吗? 此操作不可逆', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            this.shelves = []
            localStorage.removeItem('warehouseLayout')
            this.$message({
              type: 'success',
              message: '布局已清空'
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消清空操作'
            })
          })
        },
        selectShelf(index) {
          if (!this.isDragging && !this.isResizing && this.designMode) {
            // 如果按住Ctrl键，则进行多选
            if (event && event.ctrlKey) {
              if (this.isShelfSelected(index)) {
                // 如果已经选中，则取消选中
                this.selectedShelves = this.selectedShelves.filter(i => i !== index)
              } else {
                // 添加到选中列表
                this.selectedShelves.push(index)
                // 更新对齐工具栏位置
                if (this.selectedShelves.length > 1) {
                  this.updateAlignmentToolbarPosition()
                }
              }
            } else {
              // 如果已经在多选列表中，保持多选状态
              if (this.isShelfSelected(index) && this.selectedShelves.length > 1) {
                // 不做任何操作，保持当前选中状态
              } else {
                // 单选模式
                this.selectedShelves = []
                this.currentShelf = index
              }
            }
          }
        },
        startDrag(index, event) {
          if (!this.designMode) return  // 非设计模式下不允许拖动

          event.preventDefault()  // 阻止默认事件处理
          this.isDragging = true  // 设置拖动状态
          this.currentShelf = index  // 设置当前选中的货架索引

          const shelf = this.shelves[index]

          // 计算鼠标点击位置与货架左上角的偏移量
          // 保存这个偏移量是为了在拖动过程中保持鼠标相对于货架的位置不变
          this.dragOffsetX = event.clientX - shelf.x
          this.dragOffsetY = event.clientY - shelf.y

          // 在document上添加事件监听，确保鼠标移出元素后仍能捕获事件
          // 这样即使用户快速移动鼠标，拖动也能持续进行
          document.addEventListener('mousemove', this.onDrag)
          document.addEventListener('mouseup', this.onDragEnd)
        },
        onDrag(event) {
          // 如果不在拖动状态或没有选中货架，则直接返回
          if (!this.isDragging || this.currentShelf === null) return

          const warehouseEl = this.$refs.warehouseRef
          const warehouseRect = warehouseEl.getBoundingClientRect()
          const shelf = this.shelves[this.currentShelf]

          // 计算新位置，考虑鼠标偏移量
          // 减去初始点击的偏移量，确保拖动感觉自然
          let newX = event.clientX - this.dragOffsetX
          let newY = event.clientY - this.dragOffsetY

          // 如果启用了网格对齐
          if (this.gridEnabled) {
            // 查找对齐参考点
            this.findAlignmentGuides(newX, newY, shelf.width, shelf.height)

            // 对齐到网格或其他货架
            const result = this.snapToGrid(newX, newY, shelf.width, shelf.height)
            newX = result.x
            newY = result.y
          } else {
            // 隐藏对齐辅助线
            this.alignmentGuides.show = false
          }

          // 限制在仓库容器内，防止货架被拖出边界
          newX = Math.max(0, Math.min(newX, warehouseRect.width - shelf.width))
          newY = Math.max(0, Math.min(newY, warehouseRect.height - shelf.height))

          // 更新货架位置
          shelf.x = newX
          shelf.y = newY
        },
        onDragEnd() {
          // 拖动结束，重置拖动状态
          this.isDragging = false
          // 移除document上的事件监听，防止内存泄漏
          // 拖动结束后不再需要监听这些事件
          document.removeEventListener('mousemove', this.onDrag)
          document.removeEventListener('mouseup', this.onDragEnd)
        },
        startResize(index, direction, event) {
          if (!this.designMode) return  // 非设计模式下不允许调整大小

          event.preventDefault()  // 阻止默认事件
          event.stopPropagation() // 阻止事件冒泡，防止触发父元素事件

          // 设置调整大小状态
          this.isResizing = true
          this.currentShelf = index
          this.resizeDirection = direction  // 设置调整方向（nw:左上, ne:右上, sw:左下, se:右下）

          const shelf = this.shelves[index]
          // 记录初始宽高值，用于计算调整后的尺寸
          this.startWidth = shelf.width
          this.startHeight = shelf.height
          // 记录鼠标点击位置，用于计算移动距离
          this.startX = event.clientX
          this.startY = event.clientY
          // 记录货架左上角位置，用于调整左上角位置
          this.startLeft = shelf.x
          this.startTop = shelf.y

          // 在document上添加事件监听，确保鼠标移出元素后仍能捕获事件
          document.addEventListener('mousemove', this.onMouseMove)
          document.addEventListener('mouseup', this.onMouseUp)
        },
        onMouseMove(event) {
          // 如果不在调整大小状态或没有选中货架，则直接返回
          if (!this.isResizing || this.currentShelf === null) return

          // 计算鼠标相对于起始位置的移动距离
          const dx = event.clientX - this.startX
          const dy = event.clientY - this.startY
          console.log(dx, dy)

          // 获取当前正在调整的货架
          const shelf = this.shelves[this.currentShelf]

          // 根据不同的调整方向，更新货架尺寸和位置
          switch (this.resizeDirection) {
            // 右下角拖动：增加宽度和高度，位置不变
            case 'se':
              shelf.width = Math.max(60, this.startWidth + dx)  // 保证最小宽度为60px
              shelf.height = Math.max(60, this.startHeight + dy)  // 保证最小高度为60px
              break
            // 左下角拖动：减少宽度，增加高度，调整x坐标
            case 'sw':
              shelf.width = Math.max(60, this.startWidth - dx)  // 向左拖动增加宽度，向右拖动减少宽度
              shelf.x = this.startLeft + this.startWidth - shelf.width  // 调整x坐标保持右边界位置不变
              shelf.height = Math.max(60, this.startHeight + dy)  // 向下拖动增加高度
              break
            // 右上角拖动：增加宽度，减少高度，调整y坐标
            case 'ne':
              shelf.width = Math.max(60, this.startWidth + dx)  // 向右拖动增加宽度
              shelf.height = Math.max(60, this.startHeight - dy)  // 向上拖动增加高度，向下拖动减少高度
              shelf.y = this.startTop + this.startHeight - shelf.height  // 调整y坐标保持下边界位置不变
              break
            // 左上角拖动：减少宽度和高度，同时调整x和y坐标
            case 'nw':
              shelf.width = Math.max(60, this.startWidth - dx)  // 向左拖动增加宽度，向右拖动减少宽度
              shelf.x = this.startLeft + this.startWidth - shelf.width  // 调整x坐标保持右边界位置不变
              shelf.height = Math.max(60, this.startHeight - dy)  // 向上拖动增加高度，向下拖动减少高度
              shelf.y = this.startTop + this.startHeight - shelf.height  // 调整y坐标保持下边界位置不变
              break
          }
        },
        onMouseUp() {
          // 调整大小结束，重置状态
          this.isResizing = false
          this.resizeDirection = null
          // 移除document上的事件监听，防止内存泄漏
          document.removeEventListener('mousemove', this.onMouseMove)
          document.removeEventListener('mouseup', this.onMouseUp)
        },
        onWarehouseClick(event) {
          // 处理仓库容器的点击事件
          if (event.target === this.$refs.warehouseRef) {
            this.currentShelf = null

            // 如果没有按Ctrl键，则清除多选
            if (!event.ctrlKey) {
              this.clearSelectedShelves()
            }
          }
        },
        setShelfSize(size) {
          if (this.currentShelf !== null && this.shelfSizes[size]) {
            const shelf = this.shelves[this.currentShelf]
            const newSize = this.shelfSizes[size]

            // 保持货架中心位置不变
            const centerX = shelf.x + shelf.width / 2
            const centerY = shelf.y + shelf.height / 2

            // 计算新的左上角坐标
            shelf.x = centerX - newSize.width / 2
            shelf.y = centerY - newSize.height / 2

            // 设置新尺寸R
            shelf.width = newSize.width
            shelf.height = newSize.height
          }
        },
        updateWarehouseSize() {
          const warehouseEl = this.$refs.warehouseRef
          if (warehouseEl) {
            warehouseEl.style.width = this.warehouseWidth + 'px'
            warehouseEl.style.height = this.warehouseHeight + 'px'
          }
        },

        applyWarehouseSize(width, height) {
          const warehouseEl = this.$refs.warehouseRef
          if (warehouseEl && this.designMode) {
            // 检查新尺寸是否会导致货架超出边界
            if (!this.canResizeWarehouse(width, height)) {
              // 如果会超出边界，取消调整
              return
            }
            
            warehouseEl.style.width = width + 'px'
            warehouseEl.style.height = height + 'px'
            this.warehouseWidth = width
            this.warehouseHeight = height
          }
        },
        // 检查仓库调整大小是否会导致货架超出边界
        canResizeWarehouse(newWidth, newHeight) {
          // 检查是否有货架会超出新的边界
          const isSafe = this.shelves.every(shelf => {
            // 检查货架是否会超出右边界
            if (shelf.x + shelf.width > newWidth) {
              // 如果会超出，显示警告
              this.$message({
                message: `无法调整大小：货架 ${shelf.name} 将超出右边界`,
                type: 'warning',
                duration: 1500
              })
              return false
            }

            // 检查货架是否会超出下边界
            if (shelf.y + shelf.height > newHeight) {
              // 如果会超出，显示警告
              this.$message({
                message: `无法调整大小：货架 ${shelf.name} 将超出下边界`,
                type: 'warning',
                duration: 1500
              })
              return false
            }

            return true
          })

          return isSafe
        },
        startResizeWarehouse(direction, event) {
          console.log('startResizeWarehouse', direction, event)

          if (!this.designMode) return  // 非设计模式下不允许调整仓库大小

          event.preventDefault()  // 阻止默认事件
          event.stopPropagation() // 阻止事件冒泡，防止触发容器的点击事件

          // 设置仓库调整状态
          this.isResizingWarehouse = true
          this.warehouseResizeDirection = direction  // 设置调整方向（right, bottom, corner）

          const warehouseEl = this.$refs.warehouseRef
          // 记录仓库初始尺寸
          this.startWidth = warehouseEl.offsetWidth
          this.startHeight = warehouseEl.offsetHeight
          // 记录鼠标起始位置
          this.startX = event.clientX
          this.startY = event.clientY

          // 在document上添加事件监听，确保鼠标移出元素后仍能捕获事件
          document.addEventListener('mousemove', this.onWarehouseResize)
          document.addEventListener('mouseup', this.onWarehouseResizeEnd)
        },

        onWarehouseResize(event) {
          if (!this.isResizingWarehouse || !this.designMode) return

          requestAnimationFrame(() => {
            const dx = event.clientX - this.startX
            const dy = event.clientY - this.startY
            const warehouseEl = this.$refs.warehouseRef

            let newWidth = this.startWidth
            let newHeight = this.startHeight

            switch (this.warehouseResizeDirection) {
              case 'right':
                newWidth = Math.max(400, Math.min(1200, this.startWidth + dx))
                break
              case 'bottom':
                newHeight = Math.max(300, Math.min(800, this.startHeight + dy))
                break
              case 'corner':
                newWidth = Math.max(400, Math.min(1200, this.startWidth + dx))
                newHeight = Math.max(300, Math.min(800, this.startHeight + dy))
                break
            }

            // 检查新尺寸是否会导致货架超出边界
            if (!this.canResizeWarehouse(newWidth, newHeight)) {
              // 如果会超出边界，取消调整
              return
            }

            // 使用transform scale进行平滑过渡
            const scaleX = newWidth / this.warehouseWidth
            const scaleY = newHeight / this.warehouseHeight

            warehouseEl.style.width = `${newWidth}px`
            warehouseEl.style.height = `${newHeight}px`

            this.warehouseWidth = newWidth
            this.warehouseHeight = newHeight

            // 更新网格背景大小
            warehouseEl.style.backgroundSize = `${20 * scaleX}px ${20 * scaleY}px`
          })
        },

        onWarehouseResizeEnd() {
          // 仓库调整大小结束，重置状态
          this.isResizingWarehouse = false
          this.warehouseResizeDirection = null
          // 移除document上的事件监听，防止内存泄漏
          document.removeEventListener('mousemove', this.onWarehouseResize)
          document.removeEventListener('mouseup', this.onWarehouseResizeEnd)
        },

        // 搜索功能
        searchShelves() {
          if (!this.searchQuery.trim()) {
            this.clearSearch()
            return
          }

          const query = this.searchQuery.toLowerCase()
          this.filteredShelves = this.shelves.filter(shelf => {
            const idMatch = shelf.id.toString().includes(query)
            const nameMatch = shelf.name.toLowerCase().includes(query)
            return idMatch || nameMatch
          })

          this.isSearchActive = true
        },

        clearSearch() {
          this.searchQuery = ''
          this.isSearchActive = false
          this.filteredShelves = []
        },

        isShelfVisible(shelf) {
          if (!this.isSearchActive) return true
          return this.filteredShelves.some(s => s.id === shelf.id)
        },

        // 查看模式下的货架操作功能
        showShelfOptions(shelfId) {
          if (this.designMode) return

          // 如果已选中的货架被再次点击，则清除选择
          if (this.selectedShelfId === shelfId) {
            this.selectedShelfId = null
          } else {
            // 否则选中新点击的货架
            this.selectedShelfId = shelfId
          }
        },

        // 查看货架库存
        viewShelfInventory(shelf) {

          this.currentModalShelf = { ...shelf }

          this.modalData = shelf.inventory || []
          this.showModal.showInventoryDetailsModal = true
          this.selectedShelfId = null // 隐藏操作选项
        },

        // 修改货架款号
        editShelfSku(shelf) {

          this.currentModalShelf = { ...shelf }


          this.modalData = this.skuList

          // 找到当前货架使用的款号在列表中的索引
          this.selectedSkuIndex = this.skuList.findIndex(item => item.code === shelf.sku)


          this.showModal.showEditSkuModal = true
          this.selectedShelfId = null // 隐藏操作选项

          // 在下一个Vue更新周期中设置选中行
          this.$nextTick(() => {
            if (this.selectedSkuIndex >= 0 && this.$refs.skuTable) {
              this.$refs.skuTable.setCurrentRow(this.modalData[this.selectedSkuIndex])
            }
          })
        },

        // 选择款号
        handleCurrentChange(currentRow) {
          if (currentRow) {
            this.selectedSkuIndex = this.modalData.findIndex(s => s.code === currentRow.code)
          } else {
            this.selectedSkuIndex = -1
          }
        },

        // Element UI表格行样式
        tableRowClassName({ row, rowIndex }) {
          if (this.selectedSkuIndex === rowIndex) {
            return 'selected-row'
          }
          return ''
        },

        // 保存修改的款号
        saveShelfSku() {
          console.log('saveShelfSku')

          // if (this.selectedSkuIndex >= 0 && this.selectedSkuIndex < this.modalData.length) {
          //   const selectedSku = this.modalData[this.selectedSkuIndex]
          //   const shelf = this.shelves.find(s => s.id === this.currentModalShelf.id)
          //   if (shelf && selectedSku) {
          //     shelf.sku = selectedSku.code
          //     this.closeModal()
          //   }
          // }
        },

        // 关闭弹窗
        closeModal() {
          this.showModal.showInventoryDetailsModal = false
          this.showModal.showEditSkuModal = false
          this.modalData = []
          this.currentModalShelf = null
          this.selectedSkuIndex = -1
        },

        // 删除货架
        deleteShelf(index) {
          this.$confirm('确定要删除这个货架吗?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            this.shelves.splice(index, 1)
            this.currentShelf = null
            this.$message({
              type: 'success',
              message: '货架已删除'
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消删除操作'
            })
          })
        },

        // 编辑货架名称
        editShelfName(index) {
          const shelf = this.shelves[index]
          this.$prompt('请输入新的货架名称', '编辑货架名称', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            inputValue: shelf.name,
            inputPattern: /\S+/,
            inputErrorMessage: '货架名称不能为空'
          }).then(({ value }) => {
            shelf.name = value.trim()
            this.$message({
              type: 'success',
              message: '货架名称已更新'
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消编辑'
            })
          })
        },
        refreshShelfInfo() {
          // 实现刷新货架信息的逻辑
          console.log('刷新货架信息')
        },
        // 处理键盘事件
        handleKeyDown(event) {
          if (!this.designMode) return // 只在设计模式下工作

          // Ctrl+C: 复制当前选中的货架
          if (event.ctrlKey && event.key === 'c') {
            this.copySelectedShelf()
          }

          // Ctrl+V: 粘贴复制的货架
          if (event.ctrlKey && event.key === 'v') {
            this.pasteShelf()
          }
        },

        // 复制选中的货架
        copySelectedShelf() {
          if (this.currentShelf === null) {
            this.$message({
              message: '请先选择一个货架',
              type: 'warning',
              duration: 1500
            })
            return
          }

          // 深拷贝当前选中的货架
          this.copyBuffer = JSON.parse(JSON.stringify(this.shelves[this.currentShelf]))

          this.$message({
            message: `已复制货架 #${this.copyBuffer.id}`,
            type: 'success',
            duration: 1500
          })
        },

        // 粘贴货架
        pasteShelf() {
          if (!this.copyBuffer) {
            this.$message({
              message: '剪贴板中没有货架',
              type: 'warning',
              duration: 1500
            })
            return
          }

          // 创建新货架，使用复制的属性，但有新的ID和位置
          const newShelf = { ...this.copyBuffer }
          newShelf.id = this.nextId++
          newShelf.name = `${newShelf.name}-复制`

          // 设置新位置，相对于原货架有一个偏移
          newShelf.x += this.pasteOffset
          newShelf.y += this.pasteOffset

          // 确保不超出仓库边界
          const warehouseEl = this.$refs.warehouseRef
          if (warehouseEl) {
            newShelf.x = Math.min(newShelf.x, warehouseEl.clientWidth - newShelf.width)
            newShelf.y = Math.min(newShelf.y, warehouseEl.clientHeight - newShelf.height)
          }

          // 添加新货架并选中它
          this.shelves.push(newShelf)
          this.currentShelf = this.shelves.length - 1

          this.$message({
            message: `已粘贴货架 #${newShelf.id}`,
            type: 'success',
            duration: 1500
          })
        },

        // 对齐到网格
        snapToGrid(x, y, width, height) {
          let snappedX = x
          let snappedY = y

          // 1. 先检查是否与其他货架对齐
          if (this.alignmentGuides.vertical.length > 0) {
            snappedX = parseInt(this.alignmentGuides.vertical[0])
          }

          if (this.alignmentGuides.horizontal.length > 0) {
            snappedY = parseInt(this.alignmentGuides.horizontal[0])
          }

          // 2. 如果没有与其他货架对齐，则对齐到网格
          if (snappedX === x && this.gridSize > 0) {
            snappedX = Math.round(x / this.gridSize) * this.gridSize
          }

          if (snappedY === y && this.gridSize > 0) {
            snappedY = Math.round(y / this.gridSize) * this.gridSize
          }

          return { x: snappedX, y: snappedY }
        },

        // 查找对齐参考线
        findAlignmentGuides(x, y, width, height) {
          // 重置对齐辅助线
          this.alignmentGuides.vertical = []
          this.alignmentGuides.horizontal = []
          this.alignmentGuides.show = false

          // 当前货架的边界
          const currentLeft = x
          const currentRight = x + width
          const currentTop = y
          const currentBottom = y + height
          const currentCenterX = x + width / 2
          const currentCenterY = y + height / 2

          // 其他货架的关键对齐点
          const otherShelves = this.shelves.filter((_, index) => index !== this.currentShelf)

          // 遍历其他货架寻找对齐点
          for (const otherShelf of otherShelves) {
            // 其他货架的边界
            const otherLeft = otherShelf.x
            const otherRight = otherShelf.x + otherShelf.width
            const otherTop = otherShelf.y
            const otherBottom = otherShelf.y + otherShelf.height
            const otherCenterX = otherShelf.x + otherShelf.width / 2
            const otherCenterY = otherShelf.y + otherShelf.height / 2

            // 检查垂直对齐（左边对左边，右边对右边，中心对中心）
            this.checkAlignment(currentLeft, otherLeft, 'vertical')
            this.checkAlignment(currentRight, otherRight, 'vertical')
            this.checkAlignment(currentCenterX, otherCenterX, 'vertical')

            // 检查水平对齐（顶部对顶部，底部对底部，中心对中心）
            this.checkAlignment(currentTop, otherTop, 'horizontal')
            this.checkAlignment(currentBottom, otherBottom, 'horizontal')
            this.checkAlignment(currentCenterY, otherCenterY, 'horizontal')
          }

          // 如果有任何对齐线，显示它们
          this.alignmentGuides.show =
            this.alignmentGuides.vertical.length > 0 ||
            this.alignmentGuides.horizontal.length > 0
        },

        // 检查两个点是否对齐
        checkAlignment(value1, value2, direction) {
          if (Math.abs(value1 - value2) <= this.alignmentThreshold) {
            if (direction === 'vertical') {
              // 如果是垂直方向，添加垂直辅助线
              this.alignmentGuides.vertical.push(value2)
            } else {
              // 如果是水平方向，添加水平辅助线
              this.alignmentGuides.horizontal.push(value2)
            }
          }
        },

        // 开始框选
        startSelection(event) {
          // 如果在调整大小或拖动，或者在货架上点击，则不启动框选
          if (this.isResizing || this.isDragging ||
            event.target.classList.contains('shelf') ||
            event.target.closest('.shelf') ||
            event.target.classList.contains('resize-handle') ||
            event.target.classList.contains('resize-edge')) {
            return
          }

          const warehouseRect = this.$refs.warehouseRef.getBoundingClientRect()
          const startX = event.clientX - warehouseRect.left
          const startY = event.clientY - warehouseRect.top

          this.selectionBox = {
            isSelecting: true,
            startX: startX,
            startY: startY,
            x: startX,
            y: startY,
            width: 0,
            height: 0
          }
        },

        // 更新框选区域
        onSelectionMove(event) {
          if (!this.selectionBox.isSelecting || !this.designMode) return

          const warehouseRect = this.$refs.warehouseRef.getBoundingClientRect()
          let currentX = event.clientX - warehouseRect.left
          let currentY = event.clientY - warehouseRect.top

          // 限制在仓库容器内
          currentX = Math.max(0, Math.min(currentX, warehouseRect.width))
          currentY = Math.max(0, Math.min(currentY, warehouseRect.height))

          // 计算选择框的位置和大小
          const x = Math.min(this.selectionBox.startX, currentX)
          const y = Math.min(this.selectionBox.startY, currentY)
          const width = Math.abs(currentX - this.selectionBox.startX)
          const height = Math.abs(currentY - this.selectionBox.startY)

          this.selectionBox.x = x
          this.selectionBox.y = y
          this.selectionBox.width = width
          this.selectionBox.height = height
        },

        // 结束框选并确定选中的货架
        endSelection() {
          if (!this.selectionBox.isSelecting || !this.designMode) return

          // 如果框选区域过小，认为是点击事件，不执行选择
          if (this.selectionBox.width < 10 && this.selectionBox.height < 10) {
            this.selectionBox.isSelecting = false
            return
          }

          // 检查哪些货架在选择框内
          const selectedIndices = []
          this.shelves.forEach((shelf, index) => {
            // 检查货架是否与选择框相交
            if (this.isShelfInSelectionBox(shelf)) {
              selectedIndices.push(index)
            }
          })

          // 更新选中的货架
          this.selectedShelves = selectedIndices

          // 如果有选中的货架，则显示对齐工具栏
          if (this.selectedShelves.length > 1) {
            this.updateAlignmentToolbarPosition()
          }

          this.selectionBox.isSelecting = false
        },

        // 检查货架是否在选择框内
        isShelfInSelectionBox(shelf) {
          const boxLeft = this.selectionBox.x
          const boxRight = this.selectionBox.x + this.selectionBox.width
          const boxTop = this.selectionBox.y
          const boxBottom = this.selectionBox.y + this.selectionBox.height

          const shelfLeft = shelf.x
          const shelfRight = shelf.x + shelf.width
          const shelfTop = shelf.y
          const shelfBottom = shelf.y + shelf.height

          // 检查是否有交集
          return !(
            boxLeft > shelfRight ||
            boxRight < shelfLeft ||
            boxTop > shelfBottom ||
            boxBottom < shelfTop
          )
        },

        // 检查货架是否被选中
        isShelfSelected(index) {
          return this.selectedShelves.includes(index)
        },

        // 更新对齐工具栏位置
        updateAlignmentToolbarPosition() {
          // 找出所有选中货架的最小Y值和最大值
          let minY = Infinity
          let maxX = 0

          for (const index of this.selectedShelves) {
            const shelf = this.shelves[index]
            minY = Math.min(minY, shelf.y)
            maxX = Math.max(maxX, shelf.x + shelf.width)
          }

          // 将工具栏放在所有选中货架的上方和右侧
          this.alignmentToolbarPosition = {
            x: Math.min(maxX + 10, this.warehouseWidth - 250),
            y: Math.max(minY - 50, 10)
          }
        },

        // 对齐选中的货架
        alignSelectedShelves(alignment) {
          if (this.selectedShelves.length <= 1) return

          // 获取所有选中货架
          const selectedShelvesObjects = this.selectedShelves.map(index => this.shelves[index])

          // 根据对齐方式设置对齐值
          switch (alignment) {
            case 'left': {
              // 找出最左侧的x坐标
              const minX = Math.min(...selectedShelvesObjects.map(shelf => shelf.x))
              // 将所有货架左对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.x = minX
              })
              break
            }
            case 'right': {
              // 找出最右侧的x坐标
              const maxRight = Math.max(...selectedShelvesObjects.map(shelf => shelf.x + shelf.width))
              // 将所有货架右对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.x = maxRight - shelf.width
              })
              break
            }
            case 'top': {
              // 找出最顶部的y坐标
              const minY = Math.min(...selectedShelvesObjects.map(shelf => shelf.y))
              // 将所有货架上对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.y = minY
              })
              break
            }
            case 'bottom': {
              // 找出最底部的y坐标
              const maxBottom = Math.max(...selectedShelvesObjects.map(shelf => shelf.y + shelf.height))
              // 将所有货架下对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.y = maxBottom - shelf.height
              })
              break
            }
            case 'centerV': {
              // 计算垂直中心线
              const allCenters = selectedShelvesObjects.map(shelf => shelf.y + shelf.height / 2)
              const avgCenter = allCenters.reduce((sum, center) => sum + center, 0) / allCenters.length
              // 将所有货架垂直居中对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.y = avgCenter - shelf.height / 2
              })
              break
            }
            case 'centerH': {
              // 计算水平中心线
              const allCenters = selectedShelvesObjects.map(shelf => shelf.x + shelf.width / 2)
              const avgCenter = allCenters.reduce((sum, center) => sum + center, 0) / allCenters.length
              // 将所有货架水平居中对齐
              selectedShelvesObjects.forEach(shelf => {
                shelf.x = avgCenter - shelf.width / 2
              })
              break
            }
          }

          // 发送成功提示
          this.$message({
            message: '货架已对齐',
            type: 'success',
            duration: 1500
          })
        },

        // 清除选中的货架
        clearSelectedShelves() {
          this.selectedShelves = []
        },
      },
      created() {
        this.modalData = []
        this.currentModalShelf = null
        this.selectedSkuIndex = -1

        // 尝试从LocalStorage加载保存的布局
        const savedLayout = localStorage.getItem('warehouseLayout')
        if (savedLayout) {
          try {
            const layoutData = JSON.parse(savedLayout)

            if (layoutData.shelves && Array.isArray(layoutData.shelves) && layoutData.shelves.length > 0) {
              // 确保每个货架都有库存和款号属性
              layoutData.shelves.forEach(shelf => {
                if (!shelf.inventory) shelf.inventory = []
                if (!shelf.sku) shelf.sku = `SKU${shelf.id.toString().padStart(3, '0')}`
              })

              this.shelves = layoutData.shelves
              // 更新nextId为最大ID+1
              const maxId = Math.max(...layoutData.shelves.map(s => s.id))
              this.nextId = maxId + 1
            }

            // 恢复仓库尺寸
            if (layoutData.warehouseSize) {
              this.warehouseWidth = layoutData.warehouseSize.width || 800
              this.warehouseHeight = layoutData.warehouseSize.height || 600
            }
          } catch (e) {
            console.error('加载保存的布局失败', e)
          }
        }
      },
      watch: {
        designMode(newValue) {
          // 当退出设计模式时，清除当前选中的货架
          if (!newValue) {
            this.currentShelf = null

            // 确保退出设计模式时停止任何正在进行的调整大小操作
            this.isResizingWarehouse = false
            document.removeEventListener('mousemove', this.onWarehouseResize)
            document.removeEventListener('mouseup', this.onWarehouseResizeEnd)
          } else {
            // 进入设计模式时清除搜索和选中的货架
            this.clearSearch()
            this.selectedShelfId = null
          }
        }
      }
    });
  </script>
</body>

</html>